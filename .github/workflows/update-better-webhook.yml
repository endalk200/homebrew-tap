name: Update better-webhook formula

on:
  # Manual trigger with optional version override
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update to (leave empty to fetch latest)"
        required: false
        type: string
  # Check for new releases periodically
  schedule:
    - cron: "0 */12 * * *" # Every 12 hours

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest release info
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Use input version or fetch latest
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            VERSION="${VERSION#v}"
            TAG="v${VERSION}"

            # Ensure the release exists for the requested tag
            if ! gh release view "$TAG" --repo endalk200/better-webhook >/dev/null 2>&1; then
              echo "Release not found for tag: $TAG"
              exit 1
            fi
          else
            # Get the latest semver release tag (vX.Y.Z)
            TAG=$(gh release list --repo endalk200/better-webhook \
              --json tagName \
              --jq '[.[] | select(.tagName | test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))][0].tagName')
            
            if [ -z "$TAG" ]; then
              echo "No CLI release found"
              exit 0
            fi
            
            VERSION="${TAG#v}"
          fi

          {
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"
          echo "Found release: $TAG (version: $VERSION)"

      - name: Check if update needed
        id: check
        run: |
          VERSION="${{ steps.release.outputs.version }}"

          if [ -z "$VERSION" ]; then
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check current formula version
          if [ -f "Formula/better-webhook.rb" ]; then
            CURRENT=$(grep -E '^\s*version "' Formula/better-webhook.rb | head -1 | sed 's/.*version "\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"
            echo "Latest version: $VERSION"
            
            if [ "$CURRENT" = "$VERSION" ]; then
              echo "Already up to date"
              echo "needs_update=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "needs_update=true" >> "$GITHUB_OUTPUT"

      - name: Download checksums
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          rm -f checksums.txt
          gh release download "${{ steps.release.outputs.tag }}" \
            --repo endalk200/better-webhook \
            --pattern checksums.txt \
            --clobber \
            --dir .

          echo "Downloaded checksums:"
          cat checksums.txt

      - name: Extract SHA256 hashes
        if: steps.check.outputs.needs_update == 'true'
        id: hashes
        run: |
          {
            echo "darwin_arm64=$(grep 'better-webhook-darwin-arm64$' checksums.txt | cut -d' ' -f1)"
            echo "darwin_x64=$(grep 'better-webhook-darwin-x64$' checksums.txt | cut -d' ' -f1)"
            echo "linux_arm64=$(grep 'better-webhook-linux-arm64$' checksums.txt | cut -d' ' -f1)"
            echo "linux_x64=$(grep 'better-webhook-linux-x64$' checksums.txt | cut -d' ' -f1)"
          } >> "$GITHUB_OUTPUT"

      - name: Generate formula
        if: steps.check.outputs.needs_update == 'true'
        env:
          VERSION: ${{ steps.release.outputs.version }}
          DARWIN_ARM64: ${{ steps.hashes.outputs.darwin_arm64 }}
          DARWIN_X64: ${{ steps.hashes.outputs.darwin_x64 }}
          LINUX_ARM64: ${{ steps.hashes.outputs.linux_arm64 }}
          LINUX_X64: ${{ steps.hashes.outputs.linux_x64 }}
        run: |
          cat > Formula/better-webhook.rb << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          # Homebrew formula for better-webhook CLI
          # Auto-updated by update-better-webhook workflow
          class BetterWebhook < Formula
            desc "Modern CLI for developing and testing webhooks"
            homepage "https://github.com/endalk200/better-webhook"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/endalk200/better-webhook/releases/download/v#{version}/better-webhook-darwin-arm64"
                sha256 "DARWIN_ARM64_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/endalk200/better-webhook/releases/download/v#{version}/better-webhook-darwin-x64"
                sha256 "DARWIN_X64_PLACEHOLDER"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/endalk200/better-webhook/releases/download/v#{version}/better-webhook-linux-arm64"
                sha256 "LINUX_ARM64_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/endalk200/better-webhook/releases/download/v#{version}/better-webhook-linux-x64"
                sha256 "LINUX_X64_PLACEHOLDER"
              end
            end

            def install
              bin.install Dir["*"].first => "better-webhook"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/better-webhook --version")
            end
          end
          FORMULA_EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" Formula/better-webhook.rb
          sed -i "s/DARWIN_ARM64_PLACEHOLDER/$DARWIN_ARM64/g" Formula/better-webhook.rb
          sed -i "s/DARWIN_X64_PLACEHOLDER/$DARWIN_X64/g" Formula/better-webhook.rb
          sed -i "s/LINUX_ARM64_PLACEHOLDER/$LINUX_ARM64/g" Formula/better-webhook.rb
          sed -i "s/LINUX_X64_PLACEHOLDER/$LINUX_X64/g" Formula/better-webhook.rb

          echo "Generated formula:"
          cat Formula/better-webhook.rb

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ github.token }}
          commit-message: "Update better-webhook to ${{ steps.release.outputs.version }}"
          title: "Update better-webhook to ${{ steps.release.outputs.version }}"
          body: |
            Automated update of better-webhook formula to version ${{ steps.release.outputs.version }}.

            **Release:** [v${{ steps.release.outputs.version }}](https://github.com/endalk200/better-webhook/releases/tag/${{ steps.release.outputs.tag }})

            **Checksums:**
            - darwin-arm64: `${{ steps.hashes.outputs.darwin_arm64 }}`
            - darwin-x64: `${{ steps.hashes.outputs.darwin_x64 }}`
            - linux-arm64: `${{ steps.hashes.outputs.linux_arm64 }}`
            - linux-x64: `${{ steps.hashes.outputs.linux_x64 }}`

            ---
            *This PR was automatically created by the [update-better-webhook workflow](https://github.com/endalk200/homebrew-tap/actions/workflows/update-better-webhook.yml).*
          branch: update-better-webhook-${{ steps.release.outputs.version }}
          delete-branch: true
          labels: |
            automated
            formula-update
