# Homebrew Tap Setup Plan

## Overview

Set up `endalk200/homebrew-tap` as a fully-featured Homebrew tap for distributing CLI tools and macOS applications with automated bottle building.

## Repository Structure

```
homebrew-tap/
├── Formula/                    # Ruby formula files for CLI tools
│   └── .gitkeep
├── Casks/                      # Cask files for macOS GUI apps (.app/.dmg)
│   └── .gitkeep
├── .github/
│   └── workflows/
│       ├── tests.yml           # PR testing & bottle building
│       └── publish.yml         # Bottle upload on PR merge/label
├── README.md                   # Tap documentation
└── LICENSE                     # License file (MIT recommended)
```

## Implementation Steps

### 1. Create Directory Structure

Create the following directories:
- `Formula/` - For CLI tool formulae
- `Casks/` - For macOS GUI applications
- `.github/workflows/` - For GitHub Actions CI/CD

### 2. Create GitHub Actions Workflows

#### 2.1 Test Workflow (`.github/workflows/tests.yml`)

Triggered on pull requests to:
- Lint formulae with `brew style`
- Test formula installation
- Build bottles for macOS (Intel + Apple Silicon)
- Upload bottles as artifacts

#### 2.2 Publish Workflow (`.github/workflows/publish.yml`)

Triggered when PR is labeled with `pr-pull`:
- Download bottle artifacts
- Upload bottles to GitHub Releases
- Update formula with bottle block
- Close PR and push to main

### 3. Create README.md

Include:
- Tap installation instructions
- List of available formulae/casks
- How to add new formulae
- Contributing guidelines

### 4. Create Example Formula Templates

Provide templates for different tool types:
- **Go binary** - Uses `go build`
- **Rust binary** - Uses `cargo build`
- **Pre-built binary** - Downloads from GitHub Releases
- **Node.js tool** - Uses npm/npx

### 5. Create Example Cask Template

Template for distributing macOS .app bundles from GitHub Releases or other sources.

---

## Detailed File Contents

### GitHub Actions: tests.yml

```yaml
name: brew test-bot

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-bot:
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-13, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Cache Homebrew Bundler RubyGems
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-up-homebrew.outputs.gems-path }}
          key: ${{ matrix.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
          restore-keys: ${{ matrix.os }}-rubygems-

      - run: brew test-bot --only-cleanup-before

      - run: brew test-bot --only-setup

      - run: brew test-bot --only-tap-syntax

      - run: brew test-bot --only-formulae
        if: github.event_name == 'pull_request'

      - name: Upload bottles as artifact
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: bottles_${{ matrix.os }}
          path: '*.bottle.*'
```

### GitHub Actions: publish.yml

```yaml
name: brew pr-pull

on:
  pull_request_target:
    types:
      - labeled

jobs:
  pr-pull:
    if: contains(github.event.pull_request.labels.*.name, 'pr-pull')
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Set up git
        uses: Homebrew/actions/git-user-config@master

      - name: Pull bottles
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ github.token }}
          PULL_REQUEST: ${{ github.event.pull_request.number }}
        run: brew pr-pull --debug --tap=${{ github.repository }} $PULL_REQUEST

      - name: Push commits
        uses: Homebrew/actions/git-try-push@master
        with:
          token: ${{ github.token }}
          branch: main

      - name: Delete branch
        if: github.event.pull_request.head.repo.fork == false
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh pr close --delete-branch --repo ${{ github.repository }} ${{ github.event.pull_request.number }}
```

### README.md Content

```markdown
# Homebrew Tap

Personal Homebrew tap for CLI tools and applications.

## Installation

```bash
brew tap endalk200/tap
```

Or install directly:

```bash
brew install endalk200/tap/<formula>
```

## Available Formulae

| Formula | Description |
|---------|-------------|
| (your tools will be listed here) |

## Available Casks

| Cask | Description |
|------|-------------|
| (your apps will be listed here) |

## Adding a New Formula

1. Create a new branch
2. Add your formula to `Formula/`
3. Test locally: `brew install --build-from-source Formula/<name>.rb`
4. Open a PR
5. Wait for CI to build bottles
6. Add `pr-pull` label to publish

## License

MIT
```

---

## Formula Templates (for reference)

### Go Binary Formula

```ruby
class Mytool < Formula
  desc "Description of your tool"
  homepage "https://github.com/endalk200/mytool"
  url "https://github.com/endalk200/mytool/archive/refs/tags/v1.0.0.tar.gz"
  sha256 "abc123..."
  license "MIT"

  depends_on "go" => :build

  def install
    system "go", "build", *std_go_args(ldflags: "-s -w -X main.version=#{version}")
  end

  test do
    assert_match version.to_s, shell_output("#{bin}/mytool --version")
  end
end
```

### Pre-built Binary Formula (GitHub Releases)

```ruby
class Mytool < Formula
  desc "Description of your tool"
  homepage "https://github.com/endalk200/mytool"
  version "1.0.0"
  license "MIT"

  on_macos do
    on_arm do
      url "https://github.com/endalk200/mytool/releases/download/v#{version}/mytool-darwin-arm64.tar.gz"
      sha256 "abc123..."
    end
    on_intel do
      url "https://github.com/endalk200/mytool/releases/download/v#{version}/mytool-darwin-amd64.tar.gz"
      sha256 "def456..."
    end
  end

  on_linux do
    on_arm do
      url "https://github.com/endalk200/mytool/releases/download/v#{version}/mytool-linux-arm64.tar.gz"
      sha256 "ghi789..."
    end
    on_intel do
      url "https://github.com/endalk200/mytool/releases/download/v#{version}/mytool-linux-amd64.tar.gz"
      sha256 "jkl012..."
    end
  end

  def install
    bin.install "mytool"
  end

  test do
    assert_match version.to_s, shell_output("#{bin}/mytool --version")
  end
end
```

### Cask Template (macOS App)

```ruby
cask "myapp" do
  version "1.0.0"
  sha256 "abc123..."

  url "https://github.com/endalk200/myapp/releases/download/v#{version}/MyApp-#{version}.dmg"
  name "MyApp"
  desc "Description of your app"
  homepage "https://github.com/endalk200/myapp"

  app "MyApp.app"

  zap trash: [
    "~/Library/Application Support/MyApp",
    "~/Library/Preferences/com.endalk200.myapp.plist",
  ]
end
```

---

## Files to Create

| File | Purpose |
|------|---------|
| `Formula/.gitkeep` | Placeholder for formula directory |
| `Casks/.gitkeep` | Placeholder for casks directory |
| `.github/workflows/tests.yml` | CI for testing and building bottles |
| `.github/workflows/publish.yml` | CD for publishing bottles |
| `README.md` | Documentation |
| `LICENSE` | MIT License |

---

## Verification

After setup, verify by:

1. Run `brew tap endalk200/tap` locally
2. Create a test formula and open a PR
3. Confirm GitHub Actions runs tests.yml
4. Add `pr-pull` label and verify bottles upload to GitHub Releases

---

## Usage After Setup

### Adding a new CLI tool:

```bash
# Create formula
brew create https://github.com/user/tool/archive/v1.0.0.tar.gz \
  --tap endalk200/tap \
  --set-name mytool

# Test locally
brew install --build-from-source endalk200/tap/mytool

# Commit and push
cd $(brew --repository endalk200/tap)
git checkout -b add-mytool
git add Formula/mytool.rb
git commit -m "mytool 1.0.0 (new formula)"
git push -u origin add-mytool

# Create PR, wait for CI, add 'pr-pull' label
```

### Users installing your tools:

```bash
# Option 1: Direct install (auto-taps)
brew install endalk200/tap/mytool

# Option 2: Tap first, then install
brew tap endalk200/tap
brew install mytool
```
